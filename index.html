<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.hide();

    const urlParams = new URLSearchParams(window.location.search);
    const alreadySpun = urlParams.get('already_spun') === '1';

    const prizes = [
        { name: "ðŸ’… Ð”Ð¸Ð·Ð°Ð¹Ð½ Ð½Ð¾Ð³Ñ‚ÐµÐ¹", color: '#FF6B6B' },
        { name: "ðŸ§´ Ð¡ÐŸÐ Ð´Ð»Ñ Ñ€ÑƒÐº/Ð½Ð¾Ð³", color: '#4ECDC4' },
        { name: "ðŸ’° Ð¡ÐºÐ¸Ð´ÐºÐ° 10%", color: '#45B7D1' },
        { name: "ðŸ’† ÐœÐ°ÑÑÐ°Ð¶ Ð²Ð¾Ñ€Ð¾Ñ‚Ð½Ð¸ÐºÐ¾Ð²Ð¾Ð¹ Ð·Ð¾Ð½Ñ‹ 10 Ð¼Ð¸Ð½", color: '#96CEB4' },
        { name: "ðŸ’Ž Ð”ÐµÐ¿Ð¾Ð·Ð¸Ñ‚ 1 000 Ñ€ÑƒÐ±.", color: '#FFEAA7' },
        { name: "ðŸ‘‘ Ð”ÐµÐ¿Ð¾Ð·Ð¸Ñ‚ 10 000 Ñ€ÑƒÐ±.", color: '#DDA0DD' }
    ];
    const chances = [20, 20, 25, 20, 14, 1];
    const colors = prizes.map(p => p.color);

    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    const centerX = 200, centerY = 200, radius = 180;
    let currentAngle = 0;
    let spinning = false;

    function drawWheel(angle = 0) {
        ctx.clearRect(0, 0, 400, 400);
        for (let i = 0; i < prizes.length; i++) {
            const startAngle = angle + (i * 2 * Math.PI / prizes.length);
            const endAngle = angle + ((i + 1) * 2 * Math.PI / prizes.length);
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, endAngle);
            ctx.closePath();
            ctx.fillStyle = colors[i % colors.length];
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(startAngle + (endAngle - startAngle) / 2);
            ctx.textAlign = 'center';
            ctx.font = 'bold 22px Arial';
            ctx.fillStyle = '#fff';
            ctx.shadowColor = '#000';
            ctx.shadowBlur = 4;
            ctx.fillText(prizes[i].name.split(' ')[0], 120, 10);
            ctx.restore();
        }
        ctx.beginPath();
        ctx.arc(centerX, centerY, 30, 0, 2 * Math.PI);
        ctx.fillStyle = '#FFD700';
        ctx.shadowBlur = 10;
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.stroke();
    }

    function getRandomPrizeIndex() {
        const rand = Math.random() * 100;
        let cumulative = 0;
        for (let i = 0; i < chances.length; i++) {
            cumulative += chances[i];
            if (rand < cumulative) return i;
        }
        return chances.length - 1;
    }

    function spinWheel() {
        if (spinning || alreadySpun) return;
        spinning = true;
        document.getElementById('spinButton').disabled = true;

        const targetPrizeIndex = getRandomPrizeIndex();
        const anglePerSector = 2 * Math.PI / prizes.length;
        const targetAngle = (3 * Math.PI / 2) - (targetPrizeIndex + 0.5) * anglePerSector;
        const normalizedTarget = ((targetAngle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);

        const spinDuration = 3000;
        const spinAngle = 8 * 2 * Math.PI; // 8 Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚Ð¾Ð²
        const startTime = Date.now();
        const startAngle = currentAngle;

        function animateSpin() {
            const now = Date.now();
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / spinDuration, 1);
            const easeOut = 1 - Math.pow(1 - progress, 3);
            currentAngle = (startAngle + spinAngle * easeOut) % (2 * Math.PI);
            drawWheel(currentAngle);

            if (progress < 1) {
                requestAnimationFrame(animateSpin);
            } else {
                currentAngle = normalizedTarget;
                drawWheel(currentAngle);
                const wonPrize = prizes[targetPrizeIndex];
                tg.showPopup({
                    title: 'ÐŸÐ¾Ð·Ð´Ñ€Ð°Ð²Ð»ÑÐµÐ¼!',
                    message: `Ð’Ñ‹ Ð²Ñ‹Ð¸Ð³Ñ€Ð°Ð»Ð¸: ${wonPrize.name}`,
                    buttons: [{ type: 'ok', id: 'ok' }]
                }, function(buttonId) {
                    if (buttonId === 'ok') {
                        tg.sendData(JSON.stringify({ prize: wonPrize.name }));
                        // ÐÐµ Ð·Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼, Telegram Ð·Ð°ÐºÑ€Ð¾ÐµÑ‚ ÑÐ°Ð¼
                    }
                });
                spinning = false;
                document.getElementById('spinButton').disabled = false;
            }
        }
        requestAnimationFrame(animateSpin);
    }

    drawWheel(currentAngle);
    const spinBtn = document.getElementById('spinButton');
    const statusMsg = document.getElementById('statusMessage');
    if (alreadySpun) {
        spinBtn.disabled = true;
        statusMsg.innerText = 'Ð’Ñ‹ ÑƒÐ¶Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð²Ð¾Ð²Ð°Ð»Ð¸ Ð² Ñ€Ð¾Ð·Ñ‹Ð³Ñ€Ñ‹ÑˆÐµ. ÐžÐ¶Ð¸Ð´Ð°Ð¹Ñ‚Ðµ Ð·Ð²Ð¾Ð½ÐºÐ° Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°.';
    } else {
        spinBtn.addEventListener('click', spinWheel);
    }
</script>
